{% extends "base.html" %}
{% block content %}

<div class="container py-4">

  <h2 class="mb-4 text-center">Resources</h2>

  <!-- TOP TABS -->
  <ul class="nav nav-tabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="books-tab" data-bs-toggle="tab" data-bs-target="#books" type="button" role="tab">
        Books
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="phonics-tab" data-bs-toggle="tab" data-bs-target="#phonics" type="button" role="tab">
        Phonics Entry
      </button>
    </li>
  </ul>

  <!-- TAB CONTENT -->
  <div class="tab-content mt-4">

    <!-- BOOKS TAB -->
    <div class="tab-pane fade show active" id="books" role="tabpanel" aria-labelledby="books-tab">
      
      <!-- LEVEL TABS -->
      <ul class="nav nav-tabs mt-3" role="tablist">
        {% for lvl in level_tabs %}
        <li class="nav-item" role="presentation">
          <button class="nav-link {% if loop.first %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#level-{{ lvl | replace(' ','_') | lower }}">
            {{ lvl }}
          </button>
        </li>
        {% endfor %}
      </ul>

      <!-- LEVEL CONTENT -->
      <div class="tab-content mt-3">
        {% set categories = ['Story','Words','Workout','Comprehension','Test'] %}
        {% for lvl in level_tabs %}
          <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="level-{{ lvl | replace(' ','_') | lower }}">
            {% for cat in categories %}
              {% set cat_books = [] %}
              {% for b in books_by_level[lvl] %}
                {% if (b.category or '')|lower == cat|lower %}
                  {% set _ = cat_books.append(b) %}
                {% endif %}
              {% endfor %}

              {% if cat_books %}
                <h5 class="mt-3">{{ cat }}</h5>
                <div class="d-flex flex-wrap">
                  {% for b in cat_books %}
                    <div class="card p-3 m-2" style="min-width: 180px; box-shadow: 0 2px 5px rgba(0,0,0,0.08);">
                      <strong>{{ b.original_name }}</strong><br>
                      <small>Level: {{ b.levels }}</small><br>
                      <a href="{{ url_for('view_book', book_id=b.id) }}" class="btn btn-sm btn-primary mt-2">View</a>
                    </div>
                  {% endfor %}
                </div>
              {% endif %}
            {% endfor %}
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- PHONICS TAB -->
    <div class="tab-pane fade" id="phonics" role="tabpanel" aria-labelledby="phonics-tab">
      <div class="card p-4 mb-4">

        <h4>üóìÔ∏è Enter Phonics Record</h4>
        <form method="POST" action="{{ url_for('teacher_phonics') }}" id="phonicsForm">
          <div class="mb-3">
            <label>Date</label>
            <input type="date" name="date" class="form-control" required>
          </div>

          <div class="mb-3">
            <label>Student Name</label>
            <input type="text" name="student_name" class="form-control" required>
          </div>

          <div class="mb-3">
            <label>Level</label>
            <select name="level" id="levelSelect" class="form-select" required>
              <option value="" disabled selected>Select Level</option>
              {% for lvl in level_tabs %}
                <option value="{{ lvl }}">{{ lvl }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label>Book Name</label>
            <select name="book_name" id="bookSelect" class="form-select" required>
              <option value="" disabled selected>Select Book</option>
              <!-- Add all books here with data-level -->
              <option value="Snap" data-level="1">Snap</option>
              <option value="Picnic" data-level="1">Picnic</option>
              <option value="Mud" data-level="1">Mud</option>
              <option value="Animals" data-level="1">Animals</option>
              <option value="Dot" data-level="2">Dot</option>
              <option value="Tap" data-level="2">Tap</option>
              <option value="Big Pig" data-level="2">Big Pig</option>
              <option value="Jam" data-level="2">Jam</option>
              <!-- continue all other books -->
            </select>
          </div>

          <div class="mb-3">
            <label>Time Taken (in minutes)</label>
            <input type="number" name="time_taken" class="form-control" required>
          </div>

          <div class="mb-3">
            <label>Feedback</label>
            <textarea name="feedback" class="form-control" rows="3"></textarea>
          </div>

          <button type="submit" class="btn btn-success w-100">Submit Record</button>
        </form>
      </div>

      <!-- Submitted Entries -->
      <div class="card p-4">
        <h5 class="mb-3">üìö Your Submitted Entries</h5>
        {% if entries %}
          <div class="d-flex flex-wrap">
            {% for entry in entries %}
              <div class="card p-3 m-2" style="min-width: 220px; box-shadow: 0 2px 5px rgba(0,0,0,0.08);">
                <strong>{{ entry.student_name }}</strong><br>
                <small>Date: {{ entry.date }}</small><br>
                <small>Level: {{ entry.level }}</small><br>
                <small>Book: {{ entry.book_name }}</small><br>
                <small>Time Taken: {{ entry.time_taken }} min</small><br>
                <p>Feedback: {{ entry.feedback or '-' }}</p>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p>No phonics entries found.</p>
        {% endif %}
      </div>

    </div>

  </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const levelSelect = document.getElementById("levelSelect");
    const bookSelect = document.getElementById("bookSelect");
    const allOptions = Array.from(bookSelect.querySelectorAll("option[data-level]"));

    levelSelect.addEventListener("change", function() {
        const selectedLevel = this.value;

        bookSelect.innerHTML = '<option value="" disabled selected>Select Book</option>';

        allOptions.forEach(opt => {
            if(opt.dataset.level === selectedLevel) {
                const newOpt = document.createElement("option");
                newOpt.value = opt.value;
                newOpt.textContent = opt.textContent;
                newOpt.dataset.level = opt.dataset.level;
                bookSelect.appendChild(newOpt);
            }
        });
    });
});
</script>

{% endblock %}

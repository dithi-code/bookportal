<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #c2e9fb, #a1c4fd);
      font-family: "Poppins", sans-serif;
    }
    .card {
      border-radius: 15px;
      border: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .nav-tabs .nav-link.active {
      background-color: #fff;
      border-radius: 10px 10px 0 0;
      font-weight: 600;
    }
    .tab-content {
      margin-top: 20px;
    }
  </style>
</head>

<body>

<div class="container py-4">

  <div class="d-flex justify-content-between mb-3">
      <h2 class="text-dark">Admin Dashboard</h2>
      <a href="{{ url_for('logout') }}" class="btn btn-danger btn-sm">Logout</a>
  </div>

  <!-- NAV TABS -->
  <ul class="nav nav-tabs">
      <li class="nav-item">
        <a class="nav-link {% if tab=='teachers' %}active{% endif %}"
           href="{{ url_for('admin_dashboard', tab='teachers') }}">
          Teachers
        </a>
      </li>

      <li class="nav-item">
        <a class="nav-link {% if tab=='books' %}active{% endif %}"
           href="{{ url_for('admin_dashboard', tab='books') }}">
          Books
        </a>
      </li>

      <li class="nav-item">
        <a class="nav-link {% if tab=='phonics' %}active{% endif %}"
           href="{{ url_for('admin_dashboard', tab='phonics') }}">
          Phonics Entries
        </a>
      </li>

      <li class="nav-item">
        <a class="nav-link {% if tab=='notifications' %}active{% endif %}"
           href="{{ url_for('admin_dashboard', tab='notifications') }}">
          Notifications
        </a>
      </li>
  </ul>

  <!-- TAB CONTENT WRAPPER (IMPORTANT) -->
  <div class="tab-content">

    <!-- TEACHERS TAB -->
    <div class="tab-pane fade {% if tab=='teachers' %}show active{% endif %}" id="teachers">
      <div class="card p-3 mt-3">
        <h4 class="mb-3">Teacher Details</h4>

        {% if teachers|length == 0 %}
          <p>No teachers registered yet.</p>
        {% else %}
        <div class="table-responsive">
          <table class="table table-striped table-hover text-center">
            <thead class="table-dark">
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for t in teachers %}
              <tr>
                <td>{{ t.id }}</td>
                <td>{{ t.name }}</td>
                <td>{{ t.email }}</td>
                <td>
                  {% if t.is_approved %}
                    <span class="badge bg-success">Approved</span>
                  {% else %}
                    <span class="badge bg-warning">Pending</span>
                  {% endif %}
                </td>
                <td class="d-flex gap-1 justify-content-center flex-wrap">

                  <form action="{{ url_for('admin_approve', user_id=t.id) }}" method="post">
                    <button class="btn btn-success btn-sm" {% if t.is_approved %}disabled{% endif %}>Approve</button>
                  </form>

                  <form action="{{ url_for('admin_toggle_allow', user_id=t.id) }}" method="post">
                    <button class="btn btn-secondary btn-sm">
                      {% if t.allow_login %}Disable{% else %}Enable{% endif %} Login
                    </button>
                  </form>

                  <form action="{{ url_for('admin_delete', user_id=t.id) }}" method="post">
                    <button class="btn btn-danger btn-sm" onclick="return confirm('Delete this teacher?')">Delete</button>
                  </form>

                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- BOOKS TAB -->
    <div class="tab-pane fade {% if tab=='books' %}show active{% endif %}" id="books">
      <div class="card p-3 mt-3">
        <h4 class="mb-3">Upload New Book</h4>

        <form action="{{ url_for('upload_book') }}" method="POST" enctype="multipart/form-data">
          <div class="row mb-3">
            <div class="col-md-6">
              <input type="text" name="title" class="form-control" placeholder="Book Title" required>
            </div>
            <div class="col-md-6">
              <input type="file" name="file" class="form-control" accept="application/pdf" required>
            </div>
          </div>

          <!-- Levels -->
          <div class="card p-3 mb-3">
            <h6>Select Levels</h6>
            <div class="row">
              {% for i in range(1, 8) %}
                <div class="col-md-2 mb-2">
                  <label><input type="checkbox" name="levels" value="{{ i }}"> Level {{ i }}</label>
                </div>
              {% endfor %}

              {% for color in ['Red','Yellow','Green','Blue','Hindi'] %}
                <div class="col-md-2 mb-2">
                  <label><input type="checkbox" name="levels" value="{{ color }}"> {{ color }}</label>
                </div>
              {% endfor %}
            </div>
          </div>

          <!-- Category -->
          <div class="card p-3 mb-3">
            <h6>Select Category</h6>
            <select name="category" class="form-control" required>
              <option value="">Choose Category</option>
              <option>Story</option>
              <option>Words</option>
              <option>Workout</option>
              <option>Comprehension</option>
              <option>Flashcards</option>
              <option>Spoken Skill</option>
              <option>Letter Picture Cards</option>
              <option>Whiteboard</option>
              <option>Test</option>
            </select>
          </div>

          <button class="btn btn-dark w-100">Upload Book</button>
        </form>
      </div>

      <!-- Uploaded Books -->
      <div class="card p-3 mt-3">
        <h4 class="mb-3">Uploaded Books</h4>

        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>
                <th>Book Title</th>
                <th>Levels</th>
                <th>Category</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for b in books %}
              <tr>
                <td>{{ b.original_name }}</td>
                <td>{{ b.levels }}</td>
                <td>{{ b.category }}</td>
                <td class="d-flex gap-2">
                  <a href="{{ url_for('view_book', book_id=b.id) }}" class="btn btn-primary btn-sm" target="_blank">View</a>

                  <form action="{{ url_for('delete_book', book_id=b.id) }}" method="POST" onsubmit="return confirm('Delete this book?');">
                    <button class="btn btn-danger btn-sm">Delete</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      </div>
    </div>

    <!-- PHONICS TAB -->
    <div class="tab-pane fade {% if tab=='phonics' %}show active{% endif %}" id="phonics">
      <div class="card p-3 mt-3">
        <h4 class="mb-3">Phonics Entries</h4>

        {% if phonics_entries|length == 0 %}
          <p>No phonics entries found.</p>
        {% else %}

        <!-- FILTER BAR -->
        <div class="row mb-3">

          <div class="col-md-4">
            <input type="text" id="searchInput" class="form-control" placeholder="Search...">
          </div>

          <div class="col-md-4">
            <select id="levelFilter" class="form-control">
              <option value="">All Levels</option>
              {% for lvl in levels %}
              <option value="{{ lvl }}">{{ lvl }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-4">
            <select id="teacherFilter" class="form-control">
              <option value="">All Teachers</option>
              {% for t in teachers_list %}
              <option value="{{ t }}">{{ t }}</option>
              {% endfor %}
            </select>
          </div>
<div class="col-md-12 mt-2">
  <button id="resetFilters" class="btn btn-secondary w-100">Reset Filters</button>
</div>

        </div>

        <div class="table-responsive">
          <table class="table table-striped table-hover" id="phonicsTable">
            <thead class="table-dark">
              <tr>
                <th>Date</th>
                <th>Student</th>
                <th>Level</th>
                <th>Book</th>
                <th>Time Taken</th>
                <th>Teacher</th>
                <th>Feedback</th>
              </tr>
            </thead>

            <tbody>
              {% for p in phonics_entries %}
              <tr>
                <td>{{ p.date }}</td>
                <td>{{ p.student_name }}</td>
                <td>{{ p.level }}</td>
                <td>{{ p.book_name }}</td>
                <td>{{ p.time_taken }} mins</td>
                <td>{{ p.teacher.name if p.teacher else 'Unknown' }}</td>
                <td>{{ p.feedback or '-' }}</td>
              </tr>
              {% endfor %}
            </tbody>

          </table>
        </div>

        {% endif %}
      </div>
    </div>

    <!-- NOTIFICATIONS TAB -->
    <div class="tab-pane fade {% if tab=='notifications' %}show active{% endif %}" id="notifications">

      <div class="card p-3 mt-3">
        <h4>Notifications</h4>

        {% if notifications|length == 0 %}
          <p>No new notifications.</p>
        {% else %}
        <form method="POST" action="/admin/clear_notifications" class="mb-3">
          <button type="submit" class="btn btn-danger btn-sm">Clear All</button>
        </form>

        <ul class="list-group">
          {% for n in notifications %}
          <li class="list-group-item d-flex justify-content-between">
            {{ n.message }}
            <small class="text-muted">{{ n.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
          </li>
          {% endfor %}
        </ul>
        {% endif %}
      </div>
    </div>

  </div> <!-- END TAB CONTENT -->

</div> <!-- container -->

<script>
document.addEventListener("DOMContentLoaded", function () {

  const searchBox = document.getElementById("searchInput");
  const levelBox = document.getElementById("levelFilter");
  const teacherBox = document.getElementById("teacherFilter");
  const rows = document.querySelectorAll("#phonicsTable tbody tr");
  const resetBtn = document.getElementById("resetFilters");

  function filter() {
    const search = searchBox.value.toLowerCase();
    const lvl = levelBox.value;
    const t = teacherBox.value;

    rows.forEach(row => {
      const rowText = row.innerText.toLowerCase();
      const rowLevel = row.children[2].innerText;
      const rowTeacher = row.children[5].innerText;

      const okSearch = rowText.includes(search);
      const okLevel = !lvl || rowLevel === lvl;
      const okTeacher = !t || rowTeacher === t;

      row.style.display = (okSearch && okLevel && okTeacher) ? "" : "none";
    });
  }

  // ✅ RESET BUTTON OUTSIDE filter() — correct!
  resetBtn.addEventListener("click", function () {
    searchBox.value = "";
    levelBox.value = "";
    teacherBox.value = "";

    rows.forEach(row => row.style.display = "");
  });

  searchBox.addEventListener("keyup", filter);
  levelBox.addEventListener("change", filter);
  teacherBox.addEventListener("change", filter);

});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
